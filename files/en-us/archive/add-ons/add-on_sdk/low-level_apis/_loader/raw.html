<div>
<div class="warning">
<p>Support for extensions using XUL/XPCOM or the Add-on SDK was removed in Firefox 57, released November 2017. As there is no supported version of Firefox enabling these technologies, this page will be removed by December 2020.</p>

<p>Add-ons using the techniques described in this document are considered a legacy technology in Firefox. Don't use these techniques to develop new add-ons. Use <a href="/en-US/Add-ons/WebExtensions">WebExtensions</a> instead. If you maintain an add-on which uses the techniques described here, consider migrating it to use WebExtensions.</p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 53</a>, no new legacy add-ons will be accepted on addons.mozilla.org (AMO) for desktop Firefox and Firefox for Android.</strong></p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 57</a>, only extensions developed using WebExtensions APIs will be supported on Desktop Firefox and Firefox for Android. </strong></p>

<p>Even before Firefox 57, changes coming up in the Firefox platform will break many legacy extensions. These changes include multiprocess Firefox (e10s), sandboxing, and multiple content processes. Legacy extensions that are affected by these changes should migrate to use WebExtensions APIs if they can. See the <a href="https://blog.mozilla.org/addons/2017/02/16/the-road-to-firefox-57-compatibility-milestones/">"Compatibility Milestones" document</a> for more information.</p>

<p>A wiki page containing <a href="https://wiki.mozilla.org/Add-ons/developer/communication">resources, migration paths, office hours, and more</a>, is available to help developers transition to the new technologies.</p>
</div>

<section class="Quick_links" id="Quick_Links">
<ol>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions"><strong>Browser extensions</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Getting_started">Getting started</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions">What are extensions?</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">Your first extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_second_WebExtension">Your second extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension">Anatomy of an extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Examples">Example extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_next_">What next?</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Concepts">Concepts</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Using_the_JavaScript_APIs">Using the JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts">Content scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Match_patterns">Match patterns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_files">Working with files</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Internationalization">Internationalization</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Security_best_practices">Security best practices</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy">Content Security Policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Native_messaging">Native messaging</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#User_Interface">User interface</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface">User Interface</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Browser_action">Toolbar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Page_actions">Address bar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Sidebars">Sidebars</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Context_menu_items">Context menu items</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages">Options page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Extension_pages">Extension pages</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Notifications">Notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Omnibox">Address bar suggestions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/devtools_panels">Developer tools panels</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#How_to">How to</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests">Intercept HTTP requests</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Modify_a_web_page">Modify a web page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Safely_inserting_external_content_into_a_page">Insert external content</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Add_a_button_to_the_toolbar">Add a button to the toolbar</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Implement_a_settings_page">Implement a settings page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_the_Tabs_API">Work with the Tabs API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Bookmarks_API">Work with the Bookmarks API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Cookies_API">Work with the Cookies API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_contextual_identities">Work with contextual identities</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Porting">Porting</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_Google_Chrome_extension">Porting a Google Chrome extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_legacy_Firefox_add-on">Porting a legacy Firefox extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Embedded_WebExtensions">Embedded WebExtensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_the_Add-on_SDK">Comparison with the Add-on SDK</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_XUL_XPCOM_extensions">Comparison with XUL/XPCOM extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Chrome_incompatibilities">Chrome incompatibilities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Differences_between_desktop_and_Android">Differences between desktop and Android</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Firefox_workflow">Firefox workflow</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/User_experience_best_practices">User Experience</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Temporary_Installation_in_Firefox">Temporary Installation in Firefox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Debugging">Debugging</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Testing_persistent_and_restart_features">Testing persistent and restart features</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Developing_WebExtensions_for_Firefox_for_Android">Developing for Firefox for Android</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Getting_started_with_web-ext">Getting started with web-ext</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/web-ext_command_reference">web-ext command reference</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/WebExtensions_and_the_Add-on_ID">Extensions and the Add-on ID</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Request_the_right_permissions">Request the right permissions</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API">JavaScript APIs</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Browser_support_for_JavaScript_APIs">Browser support for JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/alarms">alarms</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks">bookmarks</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserAction">browserAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserSettings">browserSettings</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browsingData">browsingData</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/clipboard">clipboard</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contentScripts">contentScripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contextualIdentities">contextualIdentities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies">cookies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.inspectedWindow">devtools.inspectedWindow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.network">devtools.network</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.panels">devtools.panels</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/dns">dns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/downloads">downloads</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/events">events</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extension">extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extensionTypes">extensionTypes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/find">find</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history">history</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/i18n">i18n</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/identity">identity</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/idle">idle</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/management">management</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/menus">menus</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/notifications">notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pageAction">pageAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">pkcs11</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/privacy">privacy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/proxy">proxy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime">runtime</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/search">search</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sessions">sessions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sidebarAction">sidebarAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage">storage</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs">tabs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/topSites">topSites</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/types">types</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webNavigation">webNavigation</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest">webRequest</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/windows">windows</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json">Manifest keys</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/applications">applications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/author">author</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background">background</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_action">browser_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_settings_overrides">chrome_settings_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_url_overrides">chrome_url_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts">content_scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy">content_security_policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/default_locale">default_locale</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/description">description</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/developer">developer</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/devtools_page">devtools_page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/homepage_url">homepage_url</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/icons">icons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/incognito">incognito</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version">manifest_version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/name">name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/optional_permissions">optional_permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/options_ui">options_ui</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/page_action">page_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/protocol_handlers">protocol_handlers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/short_name">short_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/sidebar_action">sidebar_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version">version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version_name">version_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/web_accessible_resources">web_accessible_resources</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes"><strong>Themes</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser theme concepts</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_Themes/FAQ">Lightweight themes FAQ</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution"><strong>Publishing and Distribution</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Publishing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Signing and distribution overview</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Package_your_extension_">Package your extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Submitting_an_add-on">Submit an add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Source_Code_Submission">Source code submission</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Resources_for_publishers">Resources for publishers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Listing">Creating an appealing listing</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Reviews">Review policies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Agreement">Developer agreement</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Featured">Featured add-ons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Retiring_your_extension">Retiring your extension</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options">Distributing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Sideloading_add-ons">For sideloading</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_for_desktop_apps">For desktop apps</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_in_the_enterprise">For an enterprise</a></li>
  </ol>
 </li>
 <li><a href="https://discourse.mozilla.org/c/add-ons"><strong>Community and Support</strong></a></li>
 <li><a href="#">Channels</a>
  <ol>
   <li><a href="https://blog.mozilla.org/addons">Add-ons blog</a></li>
   <li><a href="https://discourse.mozilla.org/c/add-ons">Add-on forums</a></li>
   <li><a href="http://stackoverflow.com/questions/tagged/firefox-addon">Stack Overflow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/#Contact_us">Contact us</a></li>
  </ol>
 </li>
</ol>
</section>
</div>

<div class="note">
<p>Unstable</p>
</div>

<p><span class="seoSummary">Create <a href="http://wiki.commonjs.org/wiki/Modules/1.1.1">CommonJS module</a> loaders.</span></p>

<h2 id="Usage">Usage</h2>

<p>The code is intentionally authored so that it can be loaded in several ways.</p>

<ol>
 <li>
  <p>It can be loaded as a regular script tag in documents that have <a href="/en/Security_check_basics#Principals">system principals</a> (note: this does not appear to work as of 02.2016 due to "use strict" being added to the file):</p>

  <pre class="brush: html">    &lt;script type='application/javascript' src='resource://gre/modules/commonjs/toolkit/loader.js'&gt;&lt;/script&gt;
</pre>

  <p>This will expose a single <code>loader</code> object containing all of the API functions described in this document.</p>
 </li>
 <li>
  <p>It can be loaded as a <a href="/en/JavaScript_code_modules/Using">JavaScript code module</a>:</p>

  <pre class="brush: js"><code>let { Loader, Require, un</code><code>load } = Components.utils.import('resource://gre/modules/commonjs/toolkit/loader.js');</code></pre>
 </li>
 <li>
  <p>It can be required as a CommonJS module from a module loaded in the loader itself:</p>

  <pre class="brush: js"><code>let { Loader, Require</code><code>, unload } = require('toolkit/loader');</code></pre>
 </li>
</ol>

<h3 id="What_is_it_good_for">What is it good for ?</h3>

<ul>
 <li>Create somewhat standardized JS environments that people doing non-browser JS are familiar with.</li>
 <li>Provide an environment for loading <a href="http://wiki.commonjs.org/wiki/Modules/1.1.1">CommonJS style modules</a>, which makes it possible to consume <a href="http://search.npmjs.org/">lots of interesting code</a> that has already been developed.</li>
 <li>Secure each module in an isolated JS sandbox and makes any capability imports explicit via calls to the <code>require()</code> function.</li>
 <li>create task specific loaders with restricted module access.</li>
 <li>Provide unload hooks that may be used to undo changes made by anything loaded into it.</li>
</ul>

<h3 id="Instantiation">Instantiation</h3>

<p>The <code>loader</code> module provides a <code>Loader()</code> function that may be used to instantiate new loader instances:</p>

<pre class="brush: js"><code>let loader = Loader(options);</code></pre>

<h3 id="Configuration">Configuration</h3>

<p><code>Loader()</code> may be provided with a set of configuration options:</p>

<ul>
 <li><a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#paths"><code>paths</code></a>: describes where the loader should find the modules it is asked to load. <strong>Mandatory</strong>.</li>
 <li><a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#modules"><code>modules</code></a>: provides a set of module exports. <strong>Optional</strong>.</li>
 <li><a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#Globals"><code>globals</code></a>: provides a set of globals shared across modules loaded via this loader. <strong>Optional</strong>.</li>
 <li><a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#resolve"><code>resolve</code></a>: provide customized module resolution logic. <strong>Optional</strong>.</li>
 <li><a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#id"><code>id</code></a>: provide add-on id to attach to loaded modules. <strong>Optional</strong>.</li>
</ul>

<h4 id="paths">paths</h4>

<p>The loader needs to be provided with a set of locations to indicate where to find modules loaded using <code>require()</code>. This is provided by a mandatory <code>options.paths</code> hash that represents the mapping between module ID prefixes and locations. There are lots of different possibilities, but the most common setup looks like this:</p>

<pre class="brush: js"><code>let { Loader } = require('toolkit/loader');</code><code>
let loader = Loader({
  paths: {
    // Resolve all modules starting with `toolkit/` as follows:
    // toolkit/foo      -&gt;  resource://gre/modules/commonjs/toolkit/foo.js
    // toolkit/foo/bar  -&gt;  resource://gre/modules/commonjs/toolkit/foo/bar.js
    'toolkit/': 'resource://gre/modules/commonjs/toolkit/',
    // Resolve all other non-relative module requirements as follows:
    // devtools/gcli    -&gt;  resource:///modules/devtools/gcli.js
    // panel            -&gt;  resource:///modules/panel.js
    '': 'resource:///modules/',
  }
})</code></pre>

<p>All relative URL <code>require()</code> statements (those that start with ".") are first resolved relative to the requirer module ID and the result of it is then resolved using the <code>paths</code> option. You may still end up with a relative module ID if the entry point module ID is itself relative. In those cases you have to decide what the entry point module is relative to and provide an appropriate mapping for it:</p>

<pre class="brush: js"><code>let { Loader } = require('toolkit/loader');
let loader = Loader({</code><code>
  paths: {
    // Resolve all modules starting with `toolkit/` as follows:
    // toolkit/foo      -&gt;  resource://gre/modules/commonjs/toolkit/foo.js
    // toolkit/foo/bar  -&gt;  resource://gre/modules/commonjs/toolkit/foo/bar.js
    'toolkit/': 'resource://gre/modules/commonjs/toolkit/',
    // Resolev all other non-relative module requirements as follows:
    // devtools/gcli    -&gt;  resource:///modules/devtools/gcli.js
    // panel            -&gt;  resource:///modules/panel.js
    '': 'resource:///modules/',
    // Allow relative URLs and resolve them to add-on root:
    // ./main           -&gt;  resource://my-addon/root/main.js
    './': 'resource://my-addon/root/'
  }
});</code></pre>

<p>The order of keys in <code>paths</code> is irrelevant since they are sorted by keys from longest to shortest to allow overlapping mapping. The example above overlays the base path <code>''</code> with a different mapping for <code>'toolkit/'</code> prefixed modules.</p>

<h4 id="modules">modules</h4>

<p>The loader may <strong>optionally</strong> be provided with a set of module exports. In the SDK we call these "pseudo modules". This feature may be used in a few different ways:</p>

<ol>
 <li>
  <p>To expose an API that doesn't have a JS file with an implementation or is written in an incompatible format such as <a href="https://developer.mozilla.org/en/JavaScript_code_modules/Using">JSM</a>:</p>

  <pre class="brush: js"><code>let { Loader } = require('toolkit/loader');</code><code>
let loader = Loader({
  modules: {
    // require('net/utils') will get NetUtil.jsm
    'net/utils': Cu.import('resource:///modules/NetUtil.jsm', {})
  }
});</code></pre>

  <p>Each loader instance comes with a set of built-in pseudo modules that are described in detail in the <a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#Built-in_Modules">Built-in Modules</a> section.</p>
 </li>
 <li>
  <p>To reuse module instances that are already loaded. For example in the SDK, the loader is loaded at bootstrap as a JSM module but is then exposed as a pseudo-module to avoid the overhead of subsequent loads:</p>

  <pre class="brush: js"><code>let loaderModule = Cu.import('resource://gre/modules/commonjs/toolkit/loader.js');</code><code>
let loader = loaderModule.Loader({
  modules: {
    // Overlay `toolkit/loader` so that `require('toolkit/loader')`
    // will return our `loaderModule`.
    'toolkit/loader': loaderModule
  }
});</code></pre>
 </li>
</ol>

<p>Use this feature with a great care though. While reuse may sound like a compelling idea it comes with the side effect of shared state, which can cause problems. For example, unload of a loader won't trigger unload hooks on pseudo-modules.</p>

<h4 id="Globals">Globals</h4>

<p>Each module loaded via the loader instance is secured in own JS sandbox. These modules don't share scope and get their own set of built-ins (<code>Object</code>, <code>Array</code>, <code>String</code> ...). But sometimes it's convenient to define a set of common globals that will be shared across modules. This can be done using the optional <code>globals</code> option.</p>

<p>For example, the SDK uses this feature to provide a global <code>console</code> object:</p>

<pre class="brush: js"><code>let { Loader } = require('toolkit/loader');</code><code>
let loader = Loader({
  globals: {
    console: {
      log: dump.bind(dump, 'log: '),
      info: dump.bind(dump, 'info: '),
      warn: dump.bind(dump, 'warn: '),
      error: dump.bind(dump, 'error: ')
    }
  }
});</code></pre>

<p>Be careful not to misuse this feature! In general it is not recommended to provide features via globals, it's almost always better to use pseudo-modules or, even better, modules.</p>

<h4 id="resolve">resolve</h4>

<p>The optional <code>resolve</code> option enables you to completely customize module resolution logic.</p>

<p><code>resolve</code> is assigned a function that takes:</p>

<ul>
 <li>the ID of the module passed into <code>require()</code></li>
 <li>the ID of the module that called <code>require()</code></li>
</ul>

<p>On each <code>require()</code> call, the supplied function is then called with the ID of the required module and that of the requiring module.</p>

<p>The function returns a string representing the resolved module ID, which is then resolved to its location URL using the mapping provided in the <code>paths</code> option.</p>

<p>If this option is not provided, the loader will use plain path resolution.</p>

<p>This feature may also be used to implement specific security constraints. For example, the SDK generates a manifest file at build time representing a dependency graph of all modules used by an add-on. Any attempt to load a module not listed in the manifest is unauthorized and is rejected with an exception:</p>

<pre class="brush: js"><code>let { Loader } = require('toolkit/loader');</code><code>
let manifest = {
  './main': {
    'requirements': {
      'panel': 'sdk/panel'
    }
  },
  'sdk/panel': {
    'requirements': {
      'chrome': 'chrome'
    }
  }
  'chrome': {
    'requirements': {}
  }
};
let loader = Loader({
  resolve: function(id, requirer) {
    let requirements = manifest[requirer].requirements;
    if (id in manifest)
      return requirements[id];
    else
      throw Error('Module "' + requirer + '" has no authority to require ' +
                  'module "' + id + "')
  }
});</code></pre>

<p>Thrown exceptions will propagate to the caller of <code>require()</code>. If the function assigned to <code>resolve</code> does not return a string value, an exception will still be thrown as the loader will be unable to resolve the required module's location.</p>

<h4 id="id">id</h4>

<p>Add-on debugging requires knowing which objects belong to which add-on. When created with this option, Loader will transparently mark all new global objects with the provided value.</p>

<h3 id="All_Together">All Together</h3>

<p>All of these options can be combined to configure the loader for a specific use case. Don't get too excited about configuration options, keep in mind that modules are more useful if they can be used across loader instances. Unless you have specific needs it's best to stick to an SDK-compatible configuration, like this:</p>

<pre class="brush: js"><code>let { Loader } = require('toolkit/loader');
let loader = Loader({
  // Please note: Illustrated `paths` is expected to be a default base,
  // but depending on your use case you may have more mappings.
  paths: {
    // Resolve all non-relative module requirements to
    // `resource:///modules/` base URI.
    '': 'resource:///modules/',</code>

    // Reserve `toolkit/` prefix for generic, mozilla toolkit modules
    // and resolve them to `resource://gre/modules/commonjs/toolkit/` URI.
    'toolkit/': 'resource://gre/modules/commonjs/toolkit/'
  },
  // Please note: Both `globals` and `modules` are just for illustration
  // purposes we don't suggest populating them with these values.
  globals: {
    // Provide developers with well known `console` object, hopefully
    // with a more advanced implementation.
    console: {
      log: dump.bind(dump, "log: "),
      info: dump.bind(dump, "info: "),
      warn: dump.bind(dump, "warn: "),
      error: dump.bind(dump, "error: ")
    }
  },
  modules: {
    // Expose legacy API via pseudo modules that eventually may be
    // replaced with a real ones :)
    "devtools/gcli": Cu.import("resource:///modules/gcli.jsm", {}),
    "net/utils": Cu.import("resource:///modules/NetUtil.jsm", {})
  }
});</pre>

<h4 id="Loader_Instances">Loader Instances</h4>

<p>The loader produces instances that are nothing more than representations of the environment into which modules are loaded. It is intentionally made immutable and all its properties are just an implementation detail that no one should depend on, they may change at any point without any further notice.</p>

<h3 id="Loading_Modules">Loading Modules</h3>

<p>The CommonJS specification defines the notion of a <strong>main</strong> module, which represents an entry point to a program.</p>

<p>The <code>loader</code> module exposes a <code>main()</code> function that can be used to load a main module. All other modules will be loaded by this module or its dependencies:</p>

<pre class="brush: js"><code>let { main, Loader } = require('toolkit/loader');
let loader = Loader(options);</code><code>
let program = main(loader, './main');</code></pre>

<p>A module can find out whether it was loaded as main:</p>

<pre class="brush: js"><code>if (require.main === module)
  main();</code></pre>

<p>It is possible to load other modules before a main one, but it's inherently harder to do. That's because every module except main has a requirer, based on which resolution and authority decisions are made. In order to load a module before a main one (for example to bootstrap an environment) the requirer must be created first:</p>

<pre class="brush: js"><code class="brush: js">let { Require, Loader, Module } = require('toolkit/loader');
let loader = Loader(options);</code><code class="brush: js">
let requirer = Module(requirerID, requirerURI);
let require = Require(loader, requirer);
let boostrap = require(bootstrapID);</code></pre>

<h3 id="Built-in_Modules">Built-in Modules</h3>

<p>Each loader instance exposes the following built-in pseudo modules in addition to those passed via <code>modules</code>:</p>

<h4 id="chrome">chrome</h4>

<p>This pseudo module exposes everything that is typically available for JS contexts with <a href="https://developer.mozilla.org/en/Security_check_basics#Principals">system principals</a> under the <a href="https://developer.mozilla.org/en/Components">Components</a> global. This alternative approach of providing capabilities via modules makes it possible to build module capability graphs by analyzing require statements. These graphs can be used to reason about modules without diving into implementation details.</p>

<h4 id="loaderoptions">@loader/options</h4>

<p>This pseudo module exposes all the <code>options</code> that were used to configure this loader. It enables you to create new loader instances identical to the current one:</p>

<pre class="brush: js"><code>    let { Loader } = require('toolkit/loader');
    let options = require('@loader/options');</code><code>
    let loader = Loader(options);</code></pre>

<p>This module is useful in very specific cases. For example the SDK uses this feature during test execution to create an identical environment with a different state to test how specific modules handle unloads.</p>

<h4 id="loaderunload">@loader/unload</h4>

<p>This pseudo module exposes an object that is unique per loader instance. It is used as a subject for <a href="https://developer.mozilla.org/en/Observer_Notifications">observer notification</a> to allow use of the <a href="https://developer.mozilla.org/en/nsiobserverservice">observer service</a> for defining hooks reacting on the unload of a specific loader. The SDK builds a higher level API on top of this for handling unloads and performing cleanup:</p>

<pre class="brush: js">let unloadSubject = require('@loader/unload');
let observerService = Cc['@mozilla.org/observer-service;1'].
                      getService(Ci.nsIObserverService);

let observer = { observe: function onunload(subject, topic, reason) {
  // If this module is unloaded then `subject.wrappedJSObject` will be
  // `unloadSubject`. `topic` will be `'sdk:loader:destroy'`, and
  // `reason` will be a string describing the reason (e.g. `'disable'`).
  if (subject.wrappedJSObject === unloadSubject)
    console.log("I am about to unload, reason is " + reason);
}} -->;

observerService.addObserver(observer, 'sdk:loader:destroy', false);</pre>

<h3 id="Unload">Unload</h3>

<p>The <code>loader</code> module exposes an <code>unload()</code> function that can be used to unload specific loader instance and undo changes made by modules loaded into it. <code>unload</code> takes <code>loader</code> as a first argument and optionally a <code>reason</code> string identifying the reason why this loader was unloaded.</p>

<p>For example in the SDK <code>reason</code> may be one of: <code>shutdown</code>, <code>disable</code>, <code>uninstall</code>.</p>

<pre class="brush: js"><code>    unload(loader, 'disable');</code></pre>

<p>Calls to this function will dispatch the unload <a href="https://developer.mozilla.org/en/Observer_Notifications">observer notification</a> that modules can listen to as described above.</p>

<h3 id="Other_Utilities">Other Utilities</h3>

<p>The loader module exposes several other utility functions that are used internally and can also be handy while bootstrapping the loader itself. They are low level helpers and should be used only during loader bootstrap.</p>

<h4 id="Module()">Module()</h4>

<p>The <code>Module()</code> function takes a module ID and URI and creates a module instance object that is exposed as the <code>module</code> variable in the module scope.</p>

<pre class="brush: js"><code>let module  = Module('foo/bar', 'resource:///modules/foo/bar.js');</code></pre>

<p>Note that this won't actually load any module code, it just creates a placeholder for it. The section below describes how to load the module.</p>

<h4 id="load()">load()</h4>

<p>The <code>load()</code> function takes <code>loader</code> and loads the given <code>module</code> into it:</p>

<pre class="brush: js"><code>let loader = Loader(options);
let module  = Module('foo/bar', 'resource:///modules/foo/bar.js');
load(loader, module);</code></pre>

<h4 id="Sandbox()">Sandbox()</h4>

<p>The <code>Sandbox()</code> function is a utility function for creating <a href="https://developer.mozilla.org/en/Components.utils.Sandbox">JS sandboxes</a>. It is used by the loader to create scopes into which modules are loaded. It takes the following set of configuration options:</p>

<ul>
 <li><code>name</code>: A string value which identifies the sandbox in about:memory. Will throw exception if omitted.</li>
 <li><code>principal</code>: String URI or <code>nsIPrincipal</code> for the sandbox. If omitted defaults to system principal.</li>
 <li><code>prototype</code>: Object that the returned sandbox will inherit from. Defaults to <code>{}</code>.</li>
 <li><code>wantXrays</code>: A Boolean value indicating whether code outside the sandbox wants X-ray vision with respect to objects inside the sandbox. Defaults to <code>true</code>.</li>
</ul>

<pre class="brush: js"><code>   let sandbox = Sandbox({
     name: 'resource:///modules/foo/bar.js',
     wantXrays: false,</code><code>
     prototype: {
       console: {
         log: dump.bind(dump, 'log: '),
         info: dump.bind(dump, 'info: '),
         warn: dump.bind(dump, 'warn: '),
         error: dump.bind(dump, 'error: ')
       }
     }
   });</code></pre>

<h4 id="evaluate()">evaluate()</h4>

<p>Evaluates code in the supplied <code>sandbox</code>. If <code>options.source</code> is provided then its value is evaluated, otherwise source is read from the supplied <code>uri</code>. Either way, any exceptions will be reported as from the <code>uri</code>.</p>

<p>Optionally more options may be specified:</p>

<ul>
 <li><code>options.encoding</code>: source encoding, defaults to 'UTF-8'.</li>
 <li><code>options.line</code>: line number to start count from in stack traces. Defaults to 1.</li>
 <li><code>options.version</code>: version of JS used, defaults to '1.8'.</li>
</ul>

<pre class="brush: js">// Load script from the given location to a given sandbox:

 evaluate(sandbox, 'resource://path/to/script.js')


// Evaluate `code` as if it was from `foo/bar.js`:
evaluate(sandbox, 'foo/bar.js', {
  source: code,
  version: '1.7'
  // You could also use other options described above.
})</pre>

<h4 id="Require()">Require()</h4>

<p>As already mentioned in <a href="/en-US/Add-ons/SDK/Low-Level_APIs/_loader#Loading_Modules">Loading Modules</a> it's common to start execution by loading a main module. But sometimes you may want to prepare the environment using existing modules before doing that. In such cases you can create a requirer module instance and a version of <code>require</code> exposed to it with this function:</p>

<pre class="brush: js"><code>let requirer = Module(requirerID, requirerURI);
let require = Require(loader, requirer);
let boostrap = require(bootstrapID</code><code>);</code></pre>

<h4 id="resolveURI()">resolveURI()</h4>

<p>This function is used by the loader to resolve module URI from an ID using a mapping array generated from the loader's <code>paths</code> option. It examines each element until it finds the prefix matching the supplied ID and replaces it with the location it maps to:</p>

<pre class="brush: js"><code>let mapping = [
  [ 'sdk/', 'resource://gre/modules/commonjs/sdk/' ],
  [ './',       'resource://my-addon/'    ],
  [ '',         'resource:///modules/'    ]
];
resolveURI('./main', mapping);           // =&gt; resource://my-addon/main.js
resolveURI('devtools/gcli', mapping);    // =&gt; resource:///modules/devtools/gcli.js
resolveURI('sdk/core/promise', mapping);  // =&gt; resource://gre/modules/commonjs/sdk/core/promise.js</code></pre>

<h4 id="override()">override()</h4>

<p>This function is used to create a fresh object that contains own properties of two arguments it takes. If arguments have properties with conflicting names the property from the second argument overrides that from the first. This function is helpful for combining default and passed properties:</p>

<pre class="brush: js"><code>override({ a</code><code>: 1, b: 1 }, { b: 2, c: 2 }) // =&gt; { a: 1, b: 2, c: 2 }</code></pre>

<h4 id="descriptor()">descriptor()</h4>

<p>This utility function takes an object and as an argument and returns property descriptor map for its own properties. It is useful when working with object functions introduced in ES5 (<code>Object.create, Object.defineProperties, ..</code>):</p>

<pre class="brush: js"><code>// define properties of `source` o</code><code>n `target`.
Object.defineProperties(target, descriptor(source))</code></pre>